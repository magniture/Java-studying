对于开发者，无非就是关注，怎么开启-怎么查看

对于redis来说，有两个配置来帮助我们解决两个问题

- slowlog-log-slower-than，从字面意思就可以看出，这个是慢查询日志的阈值，单位是微秒，默认是10000，也就是10毫秒。也就是说当命令执行的时长超过10毫秒的时候将被记录在慢查询日志中。 

- slowlog-max-len 表示慢查询最大的保存条数，redis使用了一个列表来保存慢查询日志，slowlog-max-len就是这个列表的最大长度，当慢查询列表已经到达最大长度还需要新增的时候，最早插入的一条记录会被删除掉。

<font color="red">slowlog-log-slower-than设置为0的时候，所有命令将被记录，设置为负数则不记录任何命令</font>
    
比如我们为了测试，把测试环境的配置改为记录所有，并且慢查询列表长度为500，想要将命令修改的配置持久化到配置文件，需要执行config rewrite命令
```shell
127.0.0.1:6379> config set slowlog-log-slower-than 0
OK
127.0.0.1:6379> config set slowlog-max-len 500
OK
127.0.0.1:6379> config rewrite
```
这时候我们可以使用命令slowlog get [n]查看慢查询。
```shell
127.0.0.1:6379> slowlog get
1) 1) (integer) 42
   2) (integer) 1665233495
   3) (integer) 3
   4) 1) "set"
      2) "name"
      3) "luke"
2) 1) (integer) 41
   2) (integer) 1665233490
   3) (integer) 23
   4) 1) "slowlog"
      2) "reset"
```
从返回结果可以看出，慢查询日志由四个部分组成：
```shell
id
时间戳
耗费时间
执行的命令
```
也可以查询慢查询列表的长度
```shell
11:0>slowlog get
 1)    1)   "4"
  2)   "1668410795"
  3)   "2"
  4)      1)    "set"
   2)    "name"
   3)    "2"


 2)    1)   "3"
  2)   "1668410773"
  3)   "22"
  4)      1)    "slowlog"
   2)    "get"


 3)    1)   "2"
  2)   "1668410764"
  3)   "2"
  4)      1)    "config"
   2)    "rewrite"


 4)    1)   "1"
  2)   "1668410760"
  3)   "3"
  4)      1)    "config"
   2)    "set"
   3)    "slowlog-max-len"
   4)    "500"


 5)    1)   "0"
  2)   "1668410753"
  3)   "351"
  4)      1)    "config"
   2)    "set"
   3)    "slowlog-log-slower-than"
   4)    "0"

```
重置慢查询列表
```shell
11:0>slowlog reset
"OK"
```
## 最佳实践
慢查询日志可以帮我们在开发中和生产分析中快速找到瓶颈，但当我们使用的时候还应注意以下几点
### slowlog-log-slower-than配置建议
这个值可以适当的设置大一点，因为redis记录慢查询日志的时候会对长命令做截断操作，所以并不会占用很大的内存，这个阈值设置的大一点，可以防止丢失部分慢查询日志。
### slowlog-max-le配置建议
slowlog-max-len默认是10毫秒。但是redis是单线程模型，所以若是每条命令执行时间为1毫秒，则一秒钟才能执行1000条，QPS才为1000。因此对于高并发的场景建议设置为1毫秒。
### 分析建议
慢查询会阻塞redis，所以有客户端超时发生时，可以查看下是不是在那个时间点发生了慢查询。
### 持久化
因为慢查询队列是有大小的，遵循先进先出，所以我们可以定期将慢查询日志持久化到数据库，然后制作可视化界面进行分析。之后我们会聊到Redis的私有云CatchCloud就提供了这样的功能。
